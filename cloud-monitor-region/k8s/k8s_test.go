package k8s

import (
	c "code.cestc.cn/ccos-ops/cloud-monitor/common/config"
	"code.cestc.cn/ccos-ops/cloud-monitor/common/logger"
	"encoding/json"
	"fmt"
	"golang.org/x/net/context"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/apis/meta/v1/unstructured"
	"k8s.io/apimachinery/pkg/types"
	"strings"
	"testing"
)

func TestK8sClientCreate(t *testing.T) {
	config := c.GetCommonConfig()
	config.Env = "local"
	InitK8s()
	//str := "{  \"apiVersion\": \"monitoring.coreos.com/v1\",  \"kind\": \"PrometheusRule\",  \"metadata\": {    \"name\": \"myrule\",    \"labels\": {      \"namespace\": \"product-cec-hawkeye\",      \"prometheus\": \"k8s\",      \"role\": \"alert-rules\"    }  },  \"spec\": {    \"groups\": [      {        \"name\": \"my-node-time\",        \"rules\": [          {            \"alert\": \"myClockSkewDetected\",            \"annotations\": {              \"message\": \"myClock skew detected on node-exporter {{`{{ $labels.namespace }}`}}/{{`{{ $labels.pod }}`}}. Ensure NTP is configured correctly on this host.\"            },            \"expr\": \"abs(node_timex_offset_seconds{job=\\\"node-exporter\\\"}) > 0.03\",            \"for\": \"2m\",            \"labels\": {              \"severity\": \"warning\"            }          }        ]      }    ]  }}"
	str := "apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  creationTimestamp: '2021-11-30T08:33:16Z'\n  generation: 51\n  labels:\n    namespace: product-cec-hawkeye\n    prometheus: k8s\n    role: alert-rules\n  managedFields:\n    - apiVersion: monitoring.coreos.com/v1\n      fieldsType: FieldsV1\n      fieldsV1:\n        'f:metadata':\n          'f:labels':\n            .: {}\n            'f:namespace': {}\n            'f:prometheus': {}\n            'f:role': {}\n        'f:spec': {}\n      manager: >-\n        ___1018go_build_code_cestc_cn_ccos_ops_cloud_monitor_cloud_monitor_region.exe\n      operation: Update\n      time: '2021-11-30T08:46:39Z'\n    - apiVersion: monitoring.coreos.com/v1\n      fieldsType: FieldsV1\n      fieldsV1:\n        'f:spec':\n          'f:groups': {}\n      manager: >-\n        ___1278go_build_code_cestc_cn_ccos_ops_cloud_monitor_cloud_monitor_region.exe\n      operation: Update\n      time: '2021-12-01T02:23:02Z'\n  name: 'myrule1209'\n  namespace: product-cec-hawkeye\n  resourceVersion: '8697371'\n  selfLink: >-\n    /apis/monitoring.coreos.com/v1/namespaces/product-cec-hawkeye/prometheusrules/210310011310200\n  uid: dd5020ca-74a1-4f94-a5ae-8356c3f837a3\nspec:\n  groups:\n    - name: '210310011310200'\n      rules:\n        - alert: 915548439335403520#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548447736594432#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548495044149248#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548518725189632#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548524752404480#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548530267914240#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548534617407488#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548538979483648#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548542959878144#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n        - alert: 915548547166765056#123#e89d2f34642a32e3307872682a13397a\n          annotations:\n            description: >-\n              {\"metricName\":\"ecs_cpu_base_usage\",\"period\":10,\"times\":10,\"statistics\":\"Maximum\",\"comparisonOperator\":\"greater\",\"threshold\":10,\"unit\":\"%\",\"labels\":\"instance\",\"monitorItemName\":\"(基础)CPU的平均使用率\"}\n            summary: 'currentValue={{$value}},instance={{$labels.instance}}'\n          expr: 'max_over_time(ecs_cpu_base_usage{instance=''123''}[10s])>10'\n          for: 1m40s\n          labels:\n            app: hawkeye\n            namespace: product-cec-hawkeye\n            severity: 紧急\n"
	bytes := []byte(str)
	req := map[string]interface{}{}
	json.Unmarshal(bytes, req)
	rules := &unstructured.Unstructured{
		Object: req,
	}
	create, err := client.Resource(*resource).Namespace(namespace).Create(context.TODO(), rules, metav1.CreateOptions{})
	if err != nil {
		fmt.Printf("调用api创建规格失败 %+v", err)

	}
	fmt.Sprintf("%v", create)
}

func TestUpdateAlertRule(t *testing.T) {
	config := c.GetCommonConfig()
	config.Env = "local"
	InitK8s()
	str1 := "{\"apiVersion\":\"monitoring.coreos.com/v1\",\"kind\":\"PrometheusRule\",\"metadata\":{\"labels\":{\"namespace\":\"product-cec-hawkeye\",\"prometheus\":\"k8s\",\"role\":\"alert-rules\"},\"name\":\"110000000001001\",\"namespace\":\"product-cec-hawkeye\"},\"spec\":{\"groups\":[{\"name\":\"110000000001001\",\"rules\":[{\"alert\":\"918445744149495808#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918446289450958848#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918446454098362368#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918446518132801536#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918446589125591040#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447015992492032#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447044631199744#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447613433348096#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447716424482816#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447745025441792#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447805314367488#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447907227566080#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447907235954688#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918447907235954689#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918448029038542848#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918448204893126656#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918448220093284352#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918448265882501120#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918448460816973824#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918448460825362432#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}},{\"alert\":\"918448460825362433#123#e89d2f34642a32e3307872682a13397a\",\"annotations\":{\"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"},\"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\"for\":\"1m40s\",\"labels\":{\"app\":\"hawkeye\",\"namespace\":\"product-cec-hawkeye\",\"severity\":\"紧急\"}}]}]}}"
	//str := "{  \"apiVersion\": \"monitoring.coreos.com/v1\",  \"kind\": \"PrometheusRule\",  \"metadata\": {    \"name\": \"myrulexx\",    \"labels\": {      \"namespace\": \"product-cec-hawkeye\",      \"prometheus\": \"k8s\",      \"role\": \"alert-rules\"    }  },  \"spec\": {    \"groups\": [      {        \"name\": \"my-node-time\",        \"rules\": [          {            \"alert\": \"myClockSkewDetected\",            \"annotations\": {              \"message\": \"myClock skew detected on node-exporter {{`{{ $labels.namespace }}`}}/{{`{{ $labels.pod }}`}}. Ensure NTP is configured correctly on this host.\"            },            \"expr\": \"abs(node_timex_offset_seconds{job=\\\"node-exporter\\\"}) > 0.03\",            \"for\": \"2m\",            \"labels\": {              \"severity\": \"warning\"            }          }        ]      }    ]  }}"

	_, err := client.Resource(*resource).Namespace(namespace).Patch(context.TODO(), "110000000001001", types.MergePatchType, []byte(str1), metav1.PatchOptions{})
	if err != nil {
		logger.Logger().Errorf("调用api更新规则失败%v", err)
	}
}

func TestDeleteAlertRule(t *testing.T) {
	InitK8s()
	err := DeleteAlertRule("myrule")
	if err != nil {

	}
}

func TestStr(t *testing.T) {
	fold := strings.Compare("LoCal", "local")
	print(fold)
}

func TestApplyAlertRule(t *testing.T) {
	config := c.GetCommonConfig()
	config.Env = "local"
	InitK8s()
	str1 := "{\n    \"apiVersion\":\"monitoring.coreos.com/v1\",\n    \"kind\":\"PrometheusRule\",\n    \"metadata\":{\n        \"labels\":{\n            \"namespace\":\"product-cec-hawkeye\",\n            \"prometheus\":\"k8s\",\n            \"role\":\"alert-rules\"\n        },\n        \"name\":\"110000000001001\",\n        \"namespace\":\"product-cec-hawkeye\"\n    },\n    \"spec\":{\n        \"groups\":[\n            {\n                \"name\":\"110000000001001\",\n                \"rules\":[\n                    {\n                        \"alert\":\"918445744149495808#123#e89d2f34642a32e3307872682a13397a\",\n                        \"annotations\":{\n                            \"description\":\"{\\\"metricName\\\":\\\"ecs_cpu_base_usage\\\",\\\"period\\\":10,\\\"times\\\":10,\\\"statistics\\\":\\\"Maximum\\\",\\\"comparisonOperator\\\":\\\"greater\\\",\\\"threshold\\\":10,\\\"unit\\\":\\\"%\\\",\\\"labels\\\":\\\"instance\\\",\\\"monitorItemName\\\":\\\"(基础)CPU的平均使用率\\\"}\",\n                            \"summary\":\"currentValue={{$value}},instance={{$labels.instance}}\"\n                        },\n                        \"expr\":\"max_over_time(ecs_cpu_base_usage{instance='123'}[10s])\\u003e10\",\n                        \"for\":\"1m40s\",\n                        \"labels\":{\n                            \"app\":\"hawkeye\",\n                            \"namespace\":\"product-cec-hawkeye\",\n                            \"severity\":\"紧急\"\n                        }\n                    }                    \n                ]\n            }\n        ]\n    }\n}"
	_, err := client.Resource(*resource).Namespace(namespace).Patch(context.TODO(), "110000000001001", types.ApplyPatchType, []byte(str1), metav1.ApplyOptions{FieldManager: "application/apply-patch"}.ToPatchOptions())
	if err != nil {
		logger.Logger().Errorf("调用api更新规则失败%v", err)
	}

}
